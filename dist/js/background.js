(()=>{"use strict";class t{title;dueDate;className;taskId;taskUrl;constructor({title:t,dueDate:e,className:s,taskId:a,taskUrl:n}){this.title=t,this.dueDate=e,this.className=s,this.taskId=a,this.taskUrl=n}toJson(){return{授業名:{select:{name:this.className}},締切日時:{date:{start:this.dueDate,time_zone:"Asia/Tokyo"}},チェック:{checkbox:!1},URL:{url:this.taskUrl},課題:{title:[{text:{content:this.title}}]},panda_id:{rich_text:[{text:{content:this.taskId}}]}}}toJsonString(){return this.toJson().toString()}}class e extends class{token;NOTION_VERSION="2022-02-22";constructor(t){this.token=t}createRequestHeader(){return{"Content-type":"application/json",Authorization:"Bearer "+this.token,"Notion-Version":this.NOTION_VERSION}}}{databaseId;constructor(t,e){super(t),this.databaseId=e}async query(e={}){const s=`https://glacial-shelf-66484.herokuapp.com/https://api.notion.com/v1/databases/${this.databaseId}/query`,a={method:"POST",headers:this.createRequestHeader(),body:JSON.stringify(e)};return(await fetch(s,a).then((t=>t.json())).then((t=>t))).results.map((e=>{const s=e.properties;return new t({title:s.課題.title[0].text.content,dueDate:s.締切日時.date.start,className:s.授業名.select.name,taskId:s.panda_id?.rich_text[0]?s.panda_id?.rich_text[0].text.content:"",taskUrl:s.URL?.url??""})}))}async pushPage(t){const e=t.toJson(),s={method:"POST",headers:this.createRequestHeader(),body:JSON.stringify({parent:{database_id:this.databaseId},properties:e})};await fetch("https://glacial-shelf-66484.herokuapp.com/https://api.notion.com/v1/pages",s).then((()=>console.log(`"${t.title}" をNotionに追加しました`)))}async pushTask(e){const s=new t({title:e.taskName,dueDate:e.dateToJPNString(),className:e.className,taskId:e.taskId,taskUrl:e.getTaskUrl()});await this.pushPage(s)}}class s{taskName;dueDate;className;taskId;constructor({taskName:t,dueDate:e,className:s,taskId:a}){this.taskName=t,this.dueDate=this.fixDueDate(e),this.className=s,this.taskId=a}fixDueDate(t){return 0===t.getHours()&&0===t.getMinutes()&&(t=new Date(t.getTime()-6e4)),t}static parseTaskData(t){return{taskName:t.title,dueDate:new Date(t.dueTimeString),taskId:t.id}}isExistNotion(t){return t.map((t=>t.taskId)).includes(this.taskId)}pushToNotion(t){}dateToJPNString(){return new Date(this.dueDate.getTime()+324e5).toISOString()}}class a extends s{getTaskUrl(){return"https://panda.ecs.kyoto-u.ac.jp/portal/tool/"+this.taskId+"?panel=Main"}}class n{name;id;constructor(t,e){this.name=this.formatName(t),this.id=e}formatName=t=>{const e=t.replace(/\[.*\]/,"");let s=t.match(/[月火水木金][１-５]/)+e;return"経済学部秋田ゼミ"===s&&(s="水３"+s),"月２中国語IIＡ"===s&&(s+="（文法）"),"火４中国語IIＡ"===s&&(s+="（会話）"),s};getAssignmentUrl(){return"https://panda.ecs.kyoto-u.ac.jp/direct/assignment/site/"+this.id+".json"}getTestQuizUrl(){return"https://panda.ecs.kyoto-u.ac.jp/direct/sam_pub/context/"+this.id+".json"}static createElementFromHTML(t){return(new DOMParser).parseFromString(t,"text/html")}static async createClasses(){const t=await fetch("https://panda.ecs.kyoto-u.ac.jp/portal/site").then((t=>t.text())).then((t=>t)),e=n.createElementFromHTML(t),s=new Array(...e.querySelectorAll("ul.favoriteSiteList > li > div.fav-title > a:not([title='Home'])")),a=[];for(let t of s){const e=t.getAttribute("title");if(!e)throw new Error("タイトルが不適切です");const s=t.getAttribute("href");if(!s)throw new Error("サイトのURLが不適切です");const r=s.split("/").slice(-1)[0],i=new n(e,r);a.push(i)}return a}async createPandaTasks(){const t=this.getAssignmentUrl();return(await fetch(t).then((t=>t.json())).then((t=>t))).assignment_collection.map((t=>{const e=s.parseTaskData(t),n=Object.assign(e,{className:this.name});return new a(n)}))}}(async()=>{(async()=>{if(!class{static isIntervalEnded(t){const e="lastExecutedTime",s=localStorage.getItem(e)??"0",a=Number(s),n=new Date,r=(n.getTime()-a)/1e3/60>t;return r&&localStorage.setItem(e,n.getTime().toString()),r}}.isIntervalEnded(5))throw new Error("前回実行からまだ5分経っていないため実行を中止します");console.log("課題を取得中");const t=await n.createClasses(),s=[];for(let e of t){const t=await e.createPandaTasks();s.push(...t)}const a=new e("secret_FAq57RVurbCK8ZmUu5mKeQ5crJho5agZzFGPgUyNJ2H","2ba2cca6574d4bc883cc1d169c9d638a"),r=await a.query();s.filter((t=>!t.isExistNotion(r))),console.log("課題の取得が終了しました")})().catch((t=>console.log(t)))})()})();