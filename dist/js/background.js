(()=>{"use strict";const t="https://glacial-shelf-66484.herokuapp.com/",e="lastExecutedTime";class s{static isIntervalEnded(t){const s=localStorage.getItem(e)??"0",a=Number(s);return((new Date).getTime()-a)/1e3/60>t}static createElementFromHTML(t){return(new DOMParser).parseFromString(t,"text/html")}}class a{token;NOTION_VERSION="2022-02-22";constructor(t){this.token=t}createRequestHeader(){return{"Content-type":"application/json",Authorization:"Bearer "+this.token,"Notion-Version":this.NOTION_VERSION}}}class i extends a{pageId="";title;dueDate;className;taskId;taskUrl;isChecked;constructor(t,{pageId:e,title:s,dueDate:a,className:i,taskId:n,taskUrl:r,isChecked:o}){super(t),this.pageId=e,this.title=s,this.dueDate=a,this.className=i,this.taskId=n,this.taskUrl=r,this.isChecked=o}toJson(){return{授業名:{select:{name:this.className}},締切日時:{date:{start:this.dueDate,time_zone:"Asia/Tokyo"}},チェック:{checkbox:this.isChecked},URL:{url:this.taskUrl},課題:{title:[{text:{content:this.title}}]},panda_id:{rich_text:[{text:{content:this.taskId}}]}}}toJsonString(){return this.toJson().toString()}async update(e){const s=`${t}https://api.notion.com/v1/pages/${this.pageId}`,a={method:"PATCH",headers:this.createRequestHeader(),body:JSON.stringify({properties:e})};return fetch(s,a)}setCheckBox(t){this.update({チェック:{checkbox:t}}).then((()=>{console.log("Notionの課題'"+this.title+"'にチェックを付けました"),this.isChecked=t}))}async isSubmitted(){if(this.isChecked)return!0;const t=await fetch(this.taskUrl).then((t=>t.text()));return s.createElementFromHTML(t).querySelector("body > div.portletBody > h3 > span.highlight").innerText.includes("提出済み")}}class n extends a{databaseId;constructor(t,e){super(t),this.databaseId=e}async query(t={}){const e=`https://glacial-shelf-66484.herokuapp.com/https://api.notion.com/v1/databases/${this.databaseId}/query`,s={method:"POST",headers:this.createRequestHeader(),body:JSON.stringify(t)};return(await fetch(e,s).then((t=>t.json())).then((t=>t))).results.map((t=>{const e=t.properties;return new i(this.token,{pageId:t.id,title:e.課題.title[0]?e.課題.title[0].text.content:"",dueDate:e.締切日時.date.start,className:e.授業名.select.name,taskId:e.panda_id?.rich_text[0]?e.panda_id?.rich_text[0].text.content:"",taskUrl:e.URL?.url??"",isChecked:e.チェック?.checkbox??!1})}))}pushPage(e){const s=`${t}https://api.notion.com/v1/pages`,a=e.toJson(),i={method:"POST",headers:this.createRequestHeader(),body:JSON.stringify({parent:{database_id:this.databaseId},properties:a})};fetch(s,i).then((()=>console.log(`"${e.title}" をNotionに追加しました`)))}pushTask(t){const e=new i(this.token,{title:t.taskName,dueDate:t.dateToJPNString(),className:t.pandaClass.name,taskId:t.taskId,taskUrl:t.getTaskUrl(),isChecked:!1});this.pushPage(e)}}class r{taskName;dueDate;pandaClass;taskId;constructor({taskName:t,dueDate:e,pandaClass:s,taskId:a}){this.taskName=t,this.dueDate=this.fixDueDate(e),this.pandaClass=s,this.taskId=a}fixDueDate(t){return 0===t.getHours()&&0===t.getMinutes()&&(t=new Date(t.getTime()-6e4)),t}static parseTaskData(t){return{taskName:t.title,dueDate:new Date(t.dueTimeString),taskId:t.id}}isExistNotion(t){return t.map((t=>t.taskId)).includes(this.taskId)}pushToNotion(t){}dateToJPNString(){return new Date(this.dueDate.getTime()+324e5).toISOString()}}class o extends r{getTaskUrl(){return`https://panda.ecs.kyoto-u.ac.jp/direct/assignment/${this.taskId}`}async isSubmitted(){const t=await fetch(this.getTaskUrl()).then((t=>t.text()));return s.createElementFromHTML(t).querySelector("body > div.portletBody > h3 > span.highlight").innerText.includes("提出済み")}}class c{name;id;constructor(t,e){this.name=this.formatName(t),this.id=e}formatName=t=>{const e=t.replace(/\[.*\]/,"");let s=t.match(/[月火水木金][１-５]/)+e;return"経済学部秋田ゼミ"===s&&(s="水３"+s),"月２中国語IIＡ"===s&&(s+="（文法）"),"火４中国語IIＡ"===s&&(s+="（会話）"),s};getAssignmentUrl(){return"https://panda.ecs.kyoto-u.ac.jp/direct/assignment/site/"+this.id+".json"}getTestQuizUrl(){return"https://panda.ecs.kyoto-u.ac.jp/direct/sam_pub/context/"+this.id+".json"}static createElementFromHTML(t){return(new DOMParser).parseFromString(t,"text/html")}static async createClasses(){const t=await fetch("https://panda.ecs.kyoto-u.ac.jp/portal/site").then((t=>t.text())).then((t=>t)),e=c.createElementFromHTML(t),s=new Array(...e.querySelectorAll("ul.favoriteSiteList > li > div.fav-title > a:not([title='Home'])")),a=[];for(let t of s){const e=t.getAttribute("title");if(!e)throw new Error("タイトルが不適切です");const s=t.getAttribute("href");if(!s)throw new Error("サイトのURLが不適切です");const i=s.split("/").slice(-1)[0],n=new c(e,i);a.push(n)}return a}async createPandaTasks(){const t=this.getAssignmentUrl();return(await fetch(t).then((t=>t.json())).then((t=>t))).assignment_collection.map((t=>{const e=r.parseTaskData(t),s=Object.assign(e,{pandaClass:this});return new o(s)}))}}(async()=>{(async()=>{if(!s.isIntervalEnded(5))throw new Error("前回実行からまだ5分経っていないため実行を中止します");console.log("課題を取得中");const t=await c.createClasses(),a=[];for(let e of t){const t=await e.createPandaTasks();a.push(...t)}const i=new n("secret_FAq57RVurbCK8ZmUu5mKeQ5crJho5agZzFGPgUyNJ2H","2ba2cca6574d4bc883cc1d169c9d638a"),r=await i.query();a.filter((t=>!t.isExistNotion(r))).forEach((t=>i.pushTask(t)));for(let t of r)t.taskId&&await t.isSubmitted()&&t.setCheckBox(!0);console.log("課題の取得が終了しました"),localStorage.setItem(e,(new Date).getTime().toString())})().catch((t=>console.log(t)))})()})();